<!DOCTYPE html>
<html lang="vi">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>Qu·∫£n L√Ω Cafe</title>
    <link rel="stylesheet" href="style.css">
    <link rel="stylesheet" href="employees.css">
</head>
<body>
    <div id="app">
        <!-- Header v·ªõi tabs -->
        <header class="header">
            <div class="user-info">
                <button class="tab-btn active" data-tab="reports" title="B√°o c√°o">üìà</button>
                <button class="tab-btn" data-tab="inventory" title="Kho">üì¶</button>
                <button class="tab-btn" data-tab="statistics" title="Th·ªëng k√™">üìä</button> <!-- Th√™m tab n√†y -->
                
                    <button class="tab-btn" data-tab="employees" title="Nh√¢n vi√™n">üë•</button>
                    <button class="tab-btn" data-tab="overview" title="T·ªïng quan">üëÅ</button>
                
            </div>
        </header>

        <!-- N·ªôi dung ch√≠nh -->
        <main class="main-content">
            <!-- Tab B√°o c√°o -->
            <div id="reports" class="tab-content active"></div>

            <!-- Tab Kho -->
            <div id="inventory" class="tab-content"></div>

            <!-- Tab Th·ªëng k√™ -->
            <div id="statistics" class="tab-content"></div> <!-- Th√™m div n√†y -->

          
                <!-- Tab Nh√¢n vi√™n -->
                <div id="employees" class="tab-content"></div>

                <!-- Tab T·ªïng quan -->
                <div id="overview" class="tab-content"></div>
        
        </main>

        <!-- Popup container -->
        <div id="popupContainer" class="popup-container"></div>

        <!-- Loading overlay -->
        <div id="loadingOverlay" class="loading-overlay">
            <div class="loading-spinner">ƒêang t·∫£i...</div>
        </div>
    </div>
<body>
    <div id="app">
        <!-- Header s·∫Ω ƒë∆∞·ª£c render b·∫±ng JavaScript -->
        <header id="appHeader" class="header">
            <!-- N·ªôi dung t·∫°m th·ªùi -->
            <div class="loading-header">ƒêang t·∫£i...</div>
        </header>

        <!-- N·ªôi dung ch√≠nh -->
        <main class="main-content">
            <!-- Tab B√°o c√°o -->
            <div id="reports" class="tab-content active"></div>

            <!-- Tab Kho -->
            <div id="inventory" class="tab-content"></div>

            <!-- Tab Th·ªëng k√™ -->
            <div id="statistics" class="tab-content"></div>

            <!-- Tab Nh√¢n vi√™n (Admin only - JS s·∫Ω ·∫©n/hi·ªán) -->
            <div id="employees" class="tab-content"></div>

            <!-- Tab T·ªïng quan (Admin only - JS s·∫Ω ·∫©n/hi·ªán) -->
            <div id="overview" class="tab-content"></div>
        </main>

        <!-- Popup container -->
        <div id="popupContainer" class="popup-container"></div>

        <!-- Loading overlay -->
        <div id="loadingOverlay" class="loading-overlay">
            <div class="loading-spinner">ƒêang t·∫£i...</div>
        </div>
    </div>

    <!-- ========================= -->
    <!-- Firebase SDK              -->
    <!-- ========================= -->
    <script src="https://www.gstatic.com/firebasejs/8.10.1/firebase-app.js"></script>
    <script src="https://www.gstatic.com/firebasejs/8.10.1/firebase-firestore.js"></script>
    <script src="https://www.gstatic.com/firebasejs/8.10.1/firebase-database.js"></script>
    
    <script>
        // Kh·ªüi t·∫°o Firebase
        const firebaseConfig = {
            apiKey: "AIzaSyAcYhLhEiJk0WjQvQdwk0oNgyotp-ewKsk",
            authDomain: "milano259.firebaseapp.com",
            projectId: "milano259",
            storageBucket: "milano259.firebasestorage.app",
            messagingSenderId: "681812166818",
            appId: "1:681812166818:web:24e638784a239b0021effb",
            measurementId: "G-FSL6MSC7CT",
            databaseURL: "https://milano259-default-rtdb.asia-southeast1.firebasedatabase.app"
        };

        if (!firebase.apps.length) {
            firebase.initializeApp(firebaseConfig);
            console.log('‚úÖ Firebase initialized');
        }
    </script>

    <!-- ========================= -->
    <!-- Core scripts              -->
    <!-- ========================= -->
    <script src="database.js"></script>
    <script src="auth.js"></script>
    
    <!-- ========================= -->
    <!-- Feature scripts           -->
    <!-- ========================= -->
    <script src="reports.js"></script>
    <script src="employees.js"></script>
    <script src="inventory-period.js"></script>
    <script src="inventory.js"></script>
    <script src="statistics.js"></script>
    <script src="overview.js"></script>
    <script src="app.js"></script>


<script>
    
    document.addEventListener('DOMContentLoaded', async function() {
        try {
            console.log('üöÄ Starting app initialization...');
            
            // 1. Kh·ªüi t·∫°o database
            await initializeDatabase();
            console.log('‚úÖ Database initialized');
            
            // 2. Ki·ªÉm tra ƒëƒÉng nh·∫≠p
            const user = getCurrentUser();
            if (!user) {
                console.log('‚ö†Ô∏è User not logged in, redirecting...');
                window.location.href = 'login.html';
                return;
            }
            
            console.log('‚úÖ User logged in:', user.name, '- Role:', user.role);
            
            // 3. Render header
            renderAppHeader(user);
            
            // 4. ·∫®n c√°c tab kh√¥ng ph√π h·ª£p v·ªõi quy·ªÅn
            if (user.role !== 'admin') {
                const employeesTab = document.querySelector('[data-tab="employees"]');
                const overviewTab = document.querySelector('[data-tab="overview"]');
                
                if (employeesTab) employeesTab.style.display = 'none';
                if (overviewTab) overviewTab.style.display = 'none';
            }
            
            // 5. Setup tabs
            setupTabs();
            
            // 6. Load tab ƒë·∫ßu ti√™n
            const activeTab = document.querySelector('.tab-btn.active');
            if (activeTab) {
                const tabId = activeTab.getAttribute('data-tab');
                loadTabContent(tabId);
            }
            
            // 7. ·∫®n loading
            const loading = document.getElementById('loadingOverlay');
            if (loading) {
                setTimeout(() => {
                    loading.style.display = 'none';
                }, 500);
            }
            
        } catch (error) {
            console.error('‚ùå App initialization error:', error);
            showErrorMessage(error);
        }
    });

    // H√†m render header
    function renderAppHeader(user) {
        const header = document.getElementById('appHeader');
        if (!header) {
            console.error('‚ùå Cannot render header: #appHeader not found');
            return;
        }
        
        const isAdmin = user.role === 'admin';
        
        let tabsHTML = `
            <div class="user-info">
                <span class="user-name">üë§ ${user.name || 'Nh√¢n vi√™n'}</span>
                <span class="user-role">${isAdmin ? 'Qu·∫£n l√Ω' : 'Nh√¢n vi√™n'}</span>
                <button id="logoutBtn" class="logout-btn" title="ƒêƒÉng xu·∫•t">üö™</button>
            </div>
            <div class="tabs-container">
                <button class="tab-btn active" data-tab="reports" title="B√°o c√°o">üìà</button>
                <button class="tab-btn" data-tab="inventory" title="Kho">üì¶</button>
                <button class="tab-btn" data-tab="statistics" title="Th·ªëng k√™">üìä</button>
        `;
        
        if (isAdmin) {
            tabsHTML += `
                <button class="tab-btn" data-tab="employees" title="Nh√¢n vi√™n">üë•</button>
                <button class="tab-btn" data-tab="overview" title="T·ªïng quan">üëÅ</button>
            `;
        }
        
        tabsHTML += `</div>`;
        header.innerHTML = tabsHTML;
        
        // Th√™m s·ª± ki·ªán ƒëƒÉng xu·∫•t
        const logoutBtn = document.getElementById('logoutBtn');
        if (logoutBtn) {
            logoutBtn.addEventListener('click', function() {
                logout();
                window.location.href = 'login.html';
            });
        }
        
        console.log('‚úÖ Header rendered for user:', user.name);
    }

    // H√†m setup tabs
    function setupTabs() {
        console.log('üîÑ Setting up tabs...');
        
        const tabButtons = document.querySelectorAll('.tab-btn');
        const tabContents = document.querySelectorAll('.tab-content');
        
        tabButtons.forEach(button => {
            button.addEventListener('click', function() {
                // X√≥a active class t·ª´ t·∫•t c·∫£ tab buttons
                tabButtons.forEach(btn => btn.classList.remove('active'));
                
                // X√≥a active class t·ª´ t·∫•t c·∫£ tab contents
                tabContents.forEach(content => {
                    content.classList.remove('active');
                });
                
                // Th√™m active class cho tab button ƒë∆∞·ª£c click
                this.classList.add('active');
                
                // Hi·ªÉn th·ªã tab content t∆∞∆°ng ·ª©ng
                const tabId = this.getAttribute('data-tab');
                const tabContent = document.getElementById(tabId);
                if (tabContent) {
                    tabContent.classList.add('active');
                    
                    // Load d·ªØ li·ªáu cho tab
                    loadTabContent(tabId);
                }
            });
        });
        
        console.log(`‚úÖ Tabs setup complete (${tabButtons.length} tabs)`);
    }

    // H√†m load n·ªôi dung tab
    function loadTabContent(tabId) {
        console.log(`üìÇ Loading tab: ${tabId}`);
        
        // Hi·ªÉn th·ªã loading
        const tabContent = document.getElementById(tabId);
        if (tabContent) {
            tabContent.innerHTML = '<div class="tab-loading">ƒêang t·∫£i...</div>';
        }
        
        // G·ªçi h√†m load t∆∞∆°ng ·ª©ng
        setTimeout(() => {
            switch(tabId) {
                case 'reports':
                    if (typeof loadReports === 'function') {
                        loadReports();
                    } else {
                        console.warn('‚ö†Ô∏è loadReports function not found');
                        tabContent.innerHTML = '<div class="tab-error">Kh√¥ng th·ªÉ t·∫£i b√°o c√°o</div>';
                    }
                    break;
                    
                case 'inventory':
                    if (typeof loadInventory === 'function') {
                        loadInventory();
                    } else {
                        console.warn('‚ö†Ô∏è loadInventory function not found');
                        tabContent.innerHTML = '<div class="tab-error">Kh√¥ng th·ªÉ t·∫£i kho</div>';
                    }
                    break;
                    
                case 'statistics':
                    if (typeof loadStatistics === 'function') {
                        loadStatistics();
                    } else {
                        console.warn('‚ö†Ô∏è loadStatistics function not found');
                        tabContent.innerHTML = '<div class="tab-error">Kh√¥ng th·ªÉ t·∫£i th·ªëng k√™</div>';
                    }
                    break;
                    
                case 'employees':
                    if (typeof loadEmployeesData === 'function') {
                        loadEmployeesData();
                    } else {
                        console.warn('‚ö†Ô∏è loadEmployeesData function not found');
                        tabContent.innerHTML = '<div class="tab-error">Kh√¥ng th·ªÉ t·∫£i nh√¢n vi√™n</div>';
                    }
                    break;
                    
                case 'overview':
                    if (typeof loadOverview === 'function') {
                        loadOverview();
                    } else {
                        console.warn('‚ö†Ô∏è loadOverview function not found');
                        tabContent.innerHTML = '<div class="tab-error">Kh√¥ng th·ªÉ t·∫£i t·ªïng quan</div>';
                    }
                    break;
                    
                default:
                    console.warn(`‚ö†Ô∏è Unknown tab: ${tabId}`);
                    if (tabContent) {
                        tabContent.innerHTML = `<div class="tab-error">Tab ${tabId} kh√¥ng t·ªìn t·∫°i</div>`;
                    }
            }
        }, 100);
    }

    // H√†m hi·ªÉn th·ªã l·ªói
    function showErrorMessage(error) {
        const loading = document.getElementById('loadingOverlay');
        if (loading) {
            loading.innerHTML = `
                <div class="error-message">
                    <h3>‚ö†Ô∏è L·ªói kh·ªüi t·∫°o ·ª©ng d·ª•ng</h3>
                    <p>${error.message || 'Vui l√≤ng t·∫£i l·∫°i trang'}</p>
                    <button onclick="location.reload()" class="reload-btn">
                        T·∫£i l·∫°i trang
                    </button>
                </div>
            `;
        }
    }

    // Th√™m style cho error message
    const errorStyle = document.createElement('style');  // ƒê·ªïi t√™n bi·∫øn
errorStyle.textContent = `
        .tab-loading, .tab-error {
            padding: 40px;
            text-align: center;
            color: #666;
        }
        .error-message {
            text-align: center;
            padding: 40px;
            color: #721c24;
            background-color: #f8d7da;
            border-radius: 5px;
            margin: 20px;
        }
        .reload-btn {
            padding: 10px 20px;
            margin-top: 20px;
            background: #4CAF50;
            color: white;
            border: none;
            border-radius: 5px;
            cursor: pointer;
            font-size: 16px;
        }
        .reload-btn:hover {
            background: #45a049;
        }
    `;
    document.head.appendChild(style);
    
</script>

</body>
</html>
